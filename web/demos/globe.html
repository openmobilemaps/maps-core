<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web Map SDK Playground</title>
    <link rel="stylesheet" href="./assets/style.css" />
  </head>
  <body>
    <h1>Web Map SDK Playground</h1>
    <hr />
    <figure style="overflow: visible" id="spinner">
      <div class="spinner"></div>
      <center style="margin-top: 0.5em"><strong>emscripten</strong></center>
    </figure>
    <div class="emscripten" id="status">Downloading...</div>
    <div class="emscripten">
      <progress value="0" max="100" id="progress" hidden="1"></progress>
    </div>
    <div class="emscripten_border">
      <canvas class="emscripten" id="glCanvas" tabindex="-1"></canvas>
    </div>
    <hr />
    <div class="emscripten">
      <input type="checkbox" id="resize" />Resize canvas
      <input type="checkbox" id="pointerLock" checked />Lock/hide mouse pointer
      &nbsp;&nbsp;&nbsp;
      <input
        type="button"
        value="Fullscreen"
        onclick="module.requestFullscreen(document.getElementById('pointerLock').checked, 
                                                                                document.getElementById('resize').checked)"
      />
    </div>

    <hr />
    <textarea class="emscripten" id="output" rows="8"></textarea>
    <hr />
    <script type="module">
      import { initialize, registerAnimationLoop } from "./assets/map_setup.js";

      initialize("glCanvas", 320, true)
        .then(({ mapInterface, wmsdkModule, globalLoader }) => {
          const dataLoader = globalLoader.createLoader();
          const rasterLayer = wmsdkModule.Tiled2dMapRasterLayerInterface.create(
            wmsdkModule.DefaultTiled2dMapLayerConfigs.epsg4326Custom(
              "World",
              "https://wmsdk-playground.ubique.ch/restor_tiles/{z}/{x}/{y}.jpg",
              {
                zoomLevelScaleFactor: 1.0,
                numDrawPreviousLayers: 2,
                numDrawPreviousOrLaterTLayers: 0,
                adaptScaleToScreen: true,
                maskTile: false,
                underzoom: true,
                overzoom: true,
              },
              0,
              7
            ),
            [dataLoader]
          );
          mapInterface.addLayer(rasterLayer.asLayerInterface());

          const glowLayer = wmsdkModule.SphereEffectLayerInterface.create();
          mapInterface.addLayer(glowLayer.asLayerInterface());

          var initialPos = {
            systemIdentifier:
              wmsdkModule.CoordinateSystemIdentifiers.EPSG4326(),
            x: 8.54359994,
            y: 47.37560515,
            z: 0,
          };
          const camera = mapInterface.getCamera();
          camera.setRotationEnabled(true);
          camera.moveToCenterPosition(initialPos, false);
          camera.setZoom(5_000_000, false);
          mapInterface.resume();

          // .. animation loop..
          var startTime = document.timeline.currentTime;
          function animateMap(now) {
            const t = now - startTime;
            const cycleLen = 20 * 1000; // milliseconds
            const cycle = Math.floor(t / cycleLen);
            const minZoom = 5_000_000;
            const maxZoom = 100_000_000;
            //const maxZoom = (cycle % 2 == 0) ? 3000000 : 100000000;
            /*if(cycle % 2 == 0) {
              rasterLayer.asLayerInterface().hide();
              vectorLayer.asLayerInterface().show();
            } else {
              rasterLayer.asLayerInterface().show();
              vectorLayer.asLayerInterface().hide();
            }*/

            const fz = Math.log2(maxZoom / minZoom);
            const zt = (fz * (1 - Math.cos((t * 2 * Math.PI) / cycleLen))) / 2;
            console.log("zoom", minZoom * Math.pow(2, zt));
            camera.setZoom(minZoom * Math.pow(2, zt), false);

            const offsetX = Math.exp(t / 5000); //t-Math.sin(t * 2 * Math.PI / cycleLen) / (2 * Math.PI / cycleLen);
            var pos = {
              systemIdentifier: initialPos.systemIdentifier,
              x: ((initialPos.x + offsetX + 180) % 360) - 180,
              y: initialPos.y,
              z: initialPos.z,
            };
            camera.moveToCenterPosition(pos, false);

            window.requestAnimationFrame(animateMap);
          }
          window.requestAnimationFrame(animateMap);

          registerAnimationLoop();
        })
        .catch((err) => {
          console.error("Failed to run WebMapSDK", err);
        });
    </script>
  </body>
</html>
